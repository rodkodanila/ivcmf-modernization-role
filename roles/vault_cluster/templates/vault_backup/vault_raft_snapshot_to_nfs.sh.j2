#!/bin/bash
set -euo pipefail

NFS_MOUNT="/data/vault-backups"
HOSTNAME=$(hostname -s)
TS=$(date -u +"%Y%m%dT%H%M%SZ")
OUTFILE="${NFS_MOUNT}/vault-snapshot-${HOSTNAME}-${TS}.snap"

export VAULT_ADDR="https://127.0.0.1:8200"
export VAULT_TOKEN={{ vault_backup_token }}

# Проверяем, лидер ли эта нода
STATUS_CODE=$(curl -sk -o /dev/null -w "%{http_code}" "${VAULT_ADDR}/v1/sys/health")

if [ "$STATUS_CODE" -eq 200 ]; then
    echo "This node is leader — creating snapshot..."
    vault operator raft snapshot save "${OUTFILE}"

    # Чистим старые снапшоты
    find "${NFS_MOUNT}" -name "vault-snapshot-*.snap" -type f -mtime +{{ snapshot_retention_days }} -exec rm -f {} \;
else
    echo "This node is not leader (status ${STATUS_CODE}) — skipping snapshot."
fi